<!DOCTYPE html>
<html>
    <head>
        <title>Icebreaker</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                text-align: center;
            }

            h1 {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .icon {
                margin-right: 5px;
            }

            .container {
                margin: 20px auto;
                max-width: 600px;
            }

            .question-container {
                height: 100px;
                margin-bottom: 20px;
            }

            .question {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100%;
            }

            .button {
                background-color: #F22E52;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin-top: 10px;
            }

            #selectedUser {
                font-size: 20px;
                margin-top: 10px;
            }

            #userList {
                text-align: left;
                list-style: none;
                padding-left: 0;
            }

            #loading {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .loader-dots {
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .loader-dots div {
                width: 13px;
                height: 13px;
                margin: 3px;
                background-color: #F22E52;
                border-radius: 50%;
                animation: dots 1.4s infinite ease-in-out both;
            }

            .loader-dots div:nth-child(1) { animation-delay: -0.32s; }
            .loader-dots div:nth-child(2) { animation-delay: -0.16s; }

            @keyframes dots {
                0%, 80%, 100% { transform: scale(0); }
                40% { transform: scale(1); }
            }

            .button:disabled {
                background-color: grey;
                cursor: not-allowed;
            }

            :root {
                --background-color: white;
                --text-color: black;
            }

            body {
                background-color: var(--background-color);
                color: var(--text-color);
            }

            .dark-theme {
                --background-color: black;
                --text-color: white;
            }

            .header {
                display: flex;
            }

            .theme-button {
                margin-left: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1 class="header">
                <span><i class="fas fa-users icon"></i>Icebreaker</span>
                <button class="button theme-button" id="themeButton"><i class="fas fa-moon"></i> </button>
            </h1>
            <div class="question-container">
                <div class="question">
                    <p id="generatedQuestion">Welcome! Click the button below to generate an icebreaker question.</p>
                </div>
            </div>
            <div>
                <button class="button" id="generateQuestionButton">Generate Question</button>
            </div>
            <div>
                <button class="button" id="addUserButton">Add User</button>
                <button class="button" id="selectUserButton">Select User</button>
            </div>
            <p id="selectedUser"></p>
            <h2>User List:</h2>
            <ul id="userList"></ul>
        </div>
        <div id="loading" style="display: none;">
            <div class="loader-dots">
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
        <script>
            $(document).ready(function () {
                function getQueryParams() {
                    var params = {};
                    window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (str, key, value) {
                        params[key] = decodeURIComponent(value);
                    });
                    return params;
                }

                function addUsersFromQueryParam() {
                    var queryParams = getQueryParams();
                    var usersParam = queryParams["users"];
                    if (usersParam) {
                        var userList = $("#userList");
                        var newUsers = usersParam.split(",");
                        $.each(newUsers, function (index, username) {
                            username = username.trim();
                            if (username) {
                                var listItem = $("<li>").text(username);
                                userList.append(listItem);
                            }
                        });
                    }
                }

                addUsersFromQueryParam();

                $('#generateQuestionButton').click(async function() {
                    $("#loading").show();
                    $("#generateQuestionButton").prop("disabled", true);
                    const response = await fetch('/generate-question');
                    const data = await response.json();
                    document.getElementById('generatedQuestion').innerText = data.question;
                    $("#loading").hide();
                    $("#generateQuestionButton").prop("disabled", false);
                });

                $('#themeButton').click(function() {
                    $('body').toggleClass('dark-theme');
                    if ($('body').hasClass('dark-theme')) {
                        $(this).html('<i class="fas fa-sun"></i> ');
                    } else {
                        $(this).html('<i class="fas fa-moon"></i> ');
                    }
                });

                $("#addUserButton").click(function () {
                    var usernames = prompt("Enter usernames separated by commas:");
                    if (usernames) {
                        var userList = $("#userList");
                        var newUsers = usernames.split(",").map(function (username) {
                            return username.trim();
                        });

                        newUsers = newUsers.filter(function (username) {
                            return !userList.find("li:contains('" + username + "')").length;
                        });

                        newUsers.forEach(function (username) {
                            var listItem = $("<li>").text(username);
                            userList.append(listItem);
                        });

                        updateURLWithUsers();
                    }
                });

                function updateURLWithUsers() {
                    var userList = $("#userList li");
                    var usernames = userList
                        .map(function () {
                            return $(this).text();
                        })
                        .get()
                        .join(",");

                    var url = window.location.href;
                    var regex = /[?&]users=[^&]+/i;
                    url = url.replace(regex, "");

                    if (usernames) {
                        var separator = url.indexOf("?") === -1 ? "?" : "&";
                        var updatedURL = url + separator + "users=" + encodeURIComponent(usernames);
                        window.history.replaceState({}, "", updatedURL);
                    } else {
                        window.history.replaceState({}, "", url);
                    }
                }

                $("#selectUserButton").click(function () {
                    var userList = $("#userList");
                    var users = userList.find("li");
                    if (users.length > 0) {
                        var selectedUser = users.first().text();
                        $("#selectedUser").text("Selected User: " + selectedUser);
                        users.first().remove();

                        // Remove the question
                        var currentQuestion = $("#generatedQuestion").text();
                        var index = questions.indexOf(currentQuestion);
                        if (index > -1) {
                            questions.splice(index, 1);
                        }
                        $("#generatedQuestion").text("Question removed. Click 'Generate Question' for a new one.");
                    } else {
                        $("#selectedUser").text("No users available.");
                    }
                });
            });
        </script>
    </body>
</html>
